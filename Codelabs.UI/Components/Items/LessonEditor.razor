@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager NavManager
@rendermode InteractiveServer

<head>
    <link rel="stylesheet" href="css/buttons.css" />
    <link rel="stylesheet" href="css/items.css" />
    <link rel="stylesheet" href="css/texts.css" />
    <link rel="stylesheet" href="css/miscellaneous.css">
</head>

<div class="create-lesson-box">
    @if (IsAuthorized() && GetUserRole() == (int)RoleType.Author)
    {
        <EditForm EditContext="@_editContext">
            <DataAnnotationsValidator />
            <div class="step-box">
                @switch (_step)
                {
                    case 1:
                        <CreateLessonStep1 lessonModel="lessonModel" />
                        break;
                    case 2:
                        <CreateLessonStep2 lessonModel="lessonModel" />
                        @if (_view < 2) _view = 2;
                        break;
                    case 3:
                        <CreateLessonStep3 lessonModel="lessonModel" />
                        @if (_view < 3) _view = 3;
                        break;
                }
            </div>
            <div class="pagination-box">
                <button type="button" class="pagination-button pagination-button01" style="background-color: @GetColor(1);" @onclick="() => {ChangeStep(1);}">1</button>
                @if (_view >= 2 || EditMode)
                {
                    <button type="button" class="pagination-button pagination-button01" style="background-color: @GetColor(2);" @onclick="() => {ChangeStep(2);}">2</button>
                }
                @if (_view >= 3 || EditMode)
                {
                    <button type="button" class="pagination-button pagination-button01" style="background-color: @GetColor(3);" @onclick="() => {ChangeStep(3);}">3</button>
                }

                @if (_step != 3)
                {
                    <button type="submit" class="pagination-button pagination-button02" @onclick="ValidateCurrentStep">Далее</button>
                }
                else
                {
                    <button type="button" class="pagination-button03" @onclick="ValidateAndProceed">Завершить</button>
                }
            </div>
            <ValidationSummary class="no-display"/>
        </EditForm>
    }
    else
    {
        if (!IsAuthorized())
        {
            <div class="display-inline-block">
                <p class="not-authorized-link">Вы не авторизованы!</p>
                <a href="/login" class="scale-up-button">Авторизоваться</a>
            </div>
        }
        else if (GetUserRole() != (int)RoleType.Author)
        {
            <p class="not-authorized-link">Чтобы создавать/редактировать уроки, войдите как автор</p>
        }
    }
</div>

@code {
    [Parameter]
    public int? LessonID { get; set; }

    [Parameter]
    public bool EditMode { get; set; } = false;

    private EditContext _editContext;
    private LessonInputModel lessonModel = new();

    private int _step = 1;
    private int _view = 1;

    protected override async Task OnInitializedAsync()
    {
        if (IsAuthorized())
        {
            _editContext = new EditContext(lessonModel);

            var user = HttpContextAccessor.HttpContext.User;
            lessonModel.AuthorID = int.Parse(user.FindFirst(ClaimTypes.Name)?.Value);

            if (EditMode && LessonID != null)
            {
                var lessonManager = new LessonManager();
                var outputModel = await lessonManager.GetLessonByID((int)LessonID);
                if (outputModel != null && outputModel.Author.ID == lessonModel.AuthorID)
                {
                    lessonModel = new()
                        {
                            Name = outputModel.Name,
                            Description = outputModel.Description,
                            Cost = outputModel.Cost,
                            Content = outputModel.Content,
                            AuthorID = outputModel.Author.ID,
                            LanguageID = outputModel.Language.ID,
                            Exercises = lessonManager.MapExercisesToInputModels(outputModel.Exercises)
                        };
                }
                else
                {
                    NavManager.NavigateTo("/404");
                }
            }
        }
        await base.OnInitializedAsync();
    }

    private void ChangeStep(int nextStep)
    {
        _step = nextStep;
    }

    private async Task ValidateAndProceed()
    {
        _step = 3;
        StateHasChanged();

        var validationContext = new ValidationContext(lessonModel);
        var validationResults = new List<ValidationResult>();

        bool isValid = Validator.TryValidateObject(lessonModel, validationContext, validationResults, true);

        if (isValid)
        {
            await FinishCreating();
        }
        else
        {
            var errorProperties = validationResults.SelectMany(r => r.MemberNames).Distinct().ToList();

            if (errorProperties.Any(p => IsStage1Property(p)))
            {
                _step = 1;
            }
            else if (errorProperties.Any(p => IsStage2Property(p)))
            {
                _step = 2;
            }

            StateHasChanged();
        }
    }

    private bool IsStage1Property(string propertyName)
    {
        var stage1Properties = new[] { nameof(lessonModel.Name),
            nameof(lessonModel.Cost), nameof(lessonModel.LanguageID),
            nameof(lessonModel.Description) };
        return stage1Properties.Contains(propertyName);
    }

    private bool IsStage2Property(string propertyName)
    {
        var stage2Properties = new[] { nameof(lessonModel.Content) };
        return stage2Properties.Contains(propertyName);
    }

    private async Task ValidateCurrentStep()
    {
        var isValid = true;

        switch (_step)
        {
            case 1:
                isValid &= ValidateField(nameof(lessonModel.Name));
                isValid &= ValidateField(nameof(lessonModel.Description));
                isValid &= ValidateField(nameof(lessonModel.Cost));
                isValid &= ValidateField(nameof(lessonModel.LanguageID));
                break;
            case 2:
                isValid &= ValidateField(nameof(lessonModel.Content));
                break;
        }

        if (isValid)
        {
            if (_step < 3)
            {
                _step++;
                if (_view < _step) _view = _step;
            }
        }
    }

    private bool ValidateField(string fieldName)
    {
        var property = _editContext.Model.GetType().GetProperty(fieldName);
        var propertyValue = property?.GetValue(_editContext.Model);
        var validationContext = new ValidationContext(_editContext.Model)
            {
                MemberName = fieldName
            };

        var results = new List<ValidationResult>();
        var isValid = Validator.TryValidateProperty(propertyValue, validationContext, results);

        _editContext.NotifyValidationStateChanged();

        return isValid;
    }

    private async Task FinishCreating()
    {
        var lessonManager = new LessonManager();
        if (EditMode)
        {
            lessonManager.UpdateLessonByID((int)LessonID, lessonModel);
        }
        else
        {
            lessonManager.AddLesson(lessonModel);
        }
        NavManager.NavigateTo("/profile");
    }

    private string GetColor(int number)
    {
        return number == _step ? "#fff701" : "#01ff66";
    }

    private bool IsAuthorized()
    {
        var user = HttpContextAccessor.HttpContext.User;
        return user.Identity.IsAuthenticated;
    }

    private int? GetUserRole()
    {
        if (IsAuthorized())
        {
            var user = HttpContextAccessor.HttpContext.User;
            var role = int.Parse(user.FindFirst(ClaimTypes.Role)?.Value);
            return role;
        }
        else 
        {
            return null;
        }
    }
}